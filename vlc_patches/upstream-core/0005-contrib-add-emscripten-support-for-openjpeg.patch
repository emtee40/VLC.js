From ac12681862db84f7af45730e789b0a61abae7c0f Mon Sep 17 00:00:00 2001
From: Mehdi Sabwat <mehdi@videolabs.io>
Date: Tue, 19 May 2020 13:24:42 +0000
Subject: [PATCH 5/7] contrib: add emscripten support for openjpeg

---
 contrib/src/openjpeg/emscripten.patch | 33 +++++++++++++++++++++++++++
 contrib/src/openjpeg/rules.mak        |  1 +
 2 files changed, 34 insertions(+)
 create mode 100644 contrib/src/openjpeg/emscripten.patch

diff --git a/contrib/src/openjpeg/emscripten.patch b/contrib/src/openjpeg/emscripten.patch
new file mode 100644
index 0000000000..72645cf3c7
--- /dev/null
+++ b/contrib/src/openjpeg/emscripten.patch
@@ -0,0 +1,33 @@
+From 6f0ce2b2da4b50aa12c7e332934edbde54a75657 Mon Sep 17 00:00:00 2001
+From: mehdi <mehdi@videolabs.io>
+Date: Tue, 19 May 2020 13:18:08 +0000
+Subject: [PATCH 1/1] add emscripten support
+
+TEST_BIG_ENDIAN needs to be included from the emscripten toolchain,
+the one in CMake will fail.
+---
+ CMakeLists.txt | 7 +++++++
+ 1 file changed, 7 insertions(+)
+
+diff --git a/CMakeLists.txt b/CMakeLists.txt
+index 3ea2424a..23c090e1 100644
+--- a/CMakeLists.txt
++++ b/CMakeLists.txt
+@@ -161,7 +161,14 @@ endif()
+ 
+ #-----------------------------------------------------------------------------
+ # Big endian test:
++if (CMAKE_SYSTEM_NAME MATCHES "Emscripten")
++include ($ENV{EMSDK}/upstream/emscripten/cmake/Modules/TestBigEndian.cmake)
++else()
+ include (${CMAKE_ROOT}/Modules/TestBigEndian.cmake)
++endif()
++
++
++
+ TEST_BIG_ENDIAN(OPJ_BIG_ENDIAN)
+ 
+ #-----------------------------------------------------------------------------
+-- 
+2.26.2
+
diff --git a/contrib/src/openjpeg/rules.mak b/contrib/src/openjpeg/rules.mak
index e485651354..42f299ce51 100644
--- a/contrib/src/openjpeg/rules.mak
+++ b/contrib/src/openjpeg/rules.mak
@@ -22,6 +22,7 @@ endif
 	$(APPLY) $(SRC)/openjpeg/install.patch
 	$(APPLY) $(SRC)/openjpeg/pic.patch
 	$(APPLY) $(SRC)/openjpeg/openjp2_pthread.patch
+	$(APPLY) $(SRC)/openjpeg/emscripten.patch
 	$(call pkg_static,"./src/lib/openjp2/libopenjp2.pc.cmake.in")
 	$(MOVE)
 
-- 
2.31.1

