From de3f53417e46bfe60b7308703ce307ada77c3e22 Mon Sep 17 00:00:00 2001
From: Mehdi Sabwat <mehdi@videolabs.io>
Date: Thu, 29 Apr 2021 00:48:05 +0200
Subject: [PATCH 15/16] package: add wasm-emscriten build script

Co-Authored-By: Jean-Baptiste Kempf <jb@videolan.org>
Co-Authored-By: Etienne Brateau <etienne.brateau@gmail.com>
---
 extras/package/wasm-emscripten/build.sh | 221 ++++++++++++++++++++++++
 1 file changed, 221 insertions(+)
 create mode 100755 extras/package/wasm-emscripten/build.sh

diff --git a/extras/package/wasm-emscripten/build.sh b/extras/package/wasm-emscripten/build.sh
new file mode 100755
index 0000000000..15698dfa4b
--- /dev/null
+++ b/extras/package/wasm-emscripten/build.sh
@@ -0,0 +1,221 @@
+#! /bin/bash
+# Copyright (C) 2003-2021 the VideoLAN team
+#
+# This file is under the same license as the vlc package.
+
+diagnostic()
+{
+     echo "$@" 1>&2;
+}
+
+checkfail()
+{
+    if [ ! $? -eq 0 ];then
+        diagnostic "$1"
+        exit 1
+    fi
+}
+
+usage()
+{
+	echo "Usage: $0 [--mode=(default=1)]"
+	echo "  --mode=1 build all "
+	echo "  --mode=0 incremental build (do not bootstrap and configure) "  
+}
+
+get_symbol()
+{
+    echo "$1" | grep vlc_entry_$2 | cut -d " " -f 3
+}
+
+while test -n "$1"
+do
+    case "$1" in
+	--help|-h)
+	    usage
+	    exit 0
+	    ;;
+	--mode=*)
+	    BUILD_MODE="${1#--mode=}"
+	    ;;
+	*)
+	    echo "Unrecognized options $1"
+	    usage
+	    exit 1
+	    ;;
+    esac
+    shift
+done
+
+BUILD_MODE=${BUILD_MODE:=1}
+
+# Make in //
+if [ -z "$MAKEFLAGS" ]; then
+    UNAMES=$(uname -s)
+    MAKEFLAGS=
+    if which nproc >/dev/null; then
+        MAKEFLAGS=-j`nproc`
+    elif [ "$UNAMES" == "Darwin" ] && which sysctl >/dev/null; then
+        MAKEFLAGS=-j`sysctl -n machdep.cpu.thread_count`
+    fi
+fi
+
+diagnostic "setting up dir paths"
+
+if [ $(basename $PWD) = "vlc" ]; then #CI
+    VLC_SRCPATH="$PWD";
+    BUILD_PATH="$PWD/extras/package/wasm-emscripten/build";
+elif [ $(basename $PWD) = "wasm-emscripten" ] && [ $(basename $(dirname $PWD)) = "package" ]; then #user
+    BUILD_PATH="$PWD/build";
+    VLC_SRCPATH="$BUILD_PATH/../../../../";
+fi
+
+mkdir -p $BUILD_PATH
+
+echo $BUILD_PATH;
+echo $VLC_SRCPATH;
+
+# VLC tools
+
+mkdir -p $BUILD_PATH/extras/tools
+cd $BUILD_PATH/extras/tools
+$VLC_SRCPATH/extras/tools/bootstrap 
+checkfail "vlc tools: bootstrap failed"
+make -C $BUILD_PATH/extras/tools ${MAKEFLAGS}
+checkfail "vlc tools: make failed"
+cd $BUILD_PATH
+
+# update the PATH
+export PATH=$BUILD_PATH/extras/tools/build/bin:$PATH
+
+# SDK tests
+
+# checking if config.sub recognizes wasm32-unknown-emscripten
+dirs=( /usr/share/automake-* )
+diagnostic "using automake version: ${dirs[0]}"
+${dirs[0]}/config.sub wasm32-unknown-emscripten
+
+checkfail "sdk tests: automake does not support emscripten, patch was not applied \n
+	  [https://code.videolan.org/-/snippets/1283]"
+
+VLC_CONFIGURE_OPTIONS="
+    --host=wasm32-unknown-emscripten
+    --enable-debug
+    --disable-shared
+    --enable-dvbpsi
+    --enable-dav1d  --enable-vpx 
+    --enable-merge-ffmpeg --enable-avcodec --enable-avformat
+    --enable-opus --enable-faad 
+    --enable-gles2 
+    --disable-xcb  
+    --disable-sout --disable-lua --disable-vlm --disable-nls
+    --disable-archive --disable-live555 --disable-dc1394 --disable-dv1394 
+    --disable-linsys --disable-dvdread --disable-dvdnav --disable-bluray 
+    --disable-opencv --disable-smbclient --disable-dsm
+    --disable-sftp --disable-nfs --disable-smb2 --disable-v4l2 --disable-nvdec --disable-decklink
+    --disable-vcd --disable-libcddb --disable-screen --disable-vnc
+    --disable-freerdp --disable-asdcp  --disable-gme --disable-sid
+    --disable-ogg --disable-shout --disable-matroska --disable-mod --disable-mpc --disable-shine 
+    --disable-omxil --disable-rpi-omxil --disable-mad --disable-mpg123 --disable-gst-decode --disable-libva 
+    --disable-dxva2 --disable-d3d11va --disable-swscale --disable-postproc --disable-aom --disable-twolame 
+    --disable-fdkaac --disable-a52 --disable-dca --disable-flac --disable-libmpeg2 --disable-vorbis --disable-tremor
+    --disable-speex --disable-spatialaudio --disable-theora --disable-oggspots --disable-daala --disable-schroedinger
+    --disable-png --disable-jpeg --disable-bpg --disable-x262 --disable-x265 --disable-x264 --disable-x26410b --disable-mfx 
+    --disable-fluidsynth --disable-fluidlite --disable-zvbi --disable-telx --disable-aribsub --disable-aribb25
+    --disable-kate --disable-tiger --disable-css --disable-libplacebo --disable-vulkan --disable-vdpau --disable-wayland 
+    --disable-sdl-image --disable-freetype --disable-fribidi --disable-harfbuzz --disable-fontconfig --disable-libass --disable-svg
+    --disable-svgdec --disable-directx--disable-kms --disable-caca --disable-kva --disable-mmal --disable-alsa --disable-oss 
+    --disable-sndio --disable-wasapi --disable-jack --disable-opensles --disable-samplerate --disable-soxr --disable-kai --disable-chromaprint
+    --disable-chromecast --disable-qt --disable-qt-qml-cache --disable-qt-qml-debug --disable-skins2 --disable-libtar --disable-sparkle
+    --disable-ncurses --disable-lirc --disable-srt --disable-goom --disable-projectm --disable-vsxu --disable-avahi
+    --disable-udev --disable-mtp --disable-upnp --disable-microdns --disable-libxml2 --disable-libgcrypt --disable-gnutls --disable-taglib
+    --disable-secret --disable-kwallet --disable-update-check --disable-notify --disable-medialibrary --disable-vlc --disable-addonmanagermodules 
+    --disable-ssp
+"
+
+# Build vlc contribs
+
+mkdir -p $BUILD_PATH/contrib-emscripten
+cd $BUILD_PATH/contrib-emscripten
+$VLC_SRCPATH/contrib/bootstrap --disable-disc --disable-sout --disable-net \
+			       --enable-ffmpeg --enable-vpx --enable-dav1d \
+			       --enable-opus  --enable-faad2 \
+			       --enable-ogg --enable-dvbpsi \
+			       --disable-asdcplib --disable-fontconfig --disable-ass --disable-caca --disable-gettext --disable-gcrypt --disable-gpg-error --disable-goom --disable-harfbuzz --disable-libplacebo --disable-lua --disable-luac --disable-sqlite --disable-medialibrary --disable-mpcdec --disable-schroedinger --disable-orc --disable-postproc --disable-protobuf --disable-sidplay2 --disable-soxr --disable-spatialaudio --disable-speex --disable-speexdsp --disable-taglib --disable-zvbi --disable-rnnoise \
+			       --host=wasm32-unknown-emscripten
+checkfail "vlc contribs: bootstrap failed"
+emmake make ${MAKEFLAGS}
+checkfail "vlc contribs: make failed"
+
+cd $BUILD_PATH
+
+# Build libvlc
+
+BUILDDIR_NAME="build-emscripten"
+mkdir -p $BUILD_PATH/$BUILDDIR_NAME
+cd $BUILD_PATH/$BUILDDIR_NAME
+
+if [ $BUILD_MODE -eq 1 ]; then
+    $VLC_SRCPATH/bootstrap
+    checkfail "vlc build: bootstrap failed"
+    
+    # wasm-emscripten configure :
+    # if_nameindex is not supported in emscripten
+    # ie: not exposed from musl to src/library.js
+    # the test in configure.ac fails because htons is not
+    # in src/deps_info.json
+    # Note :
+    # search.h is a blacklisted module
+    # shm.h is a blacklisted module
+    emconfigure $VLC_SRCPATH/configure ${VLC_CONFIGURE_OPTIONS} ac_cv_func_if_nameindex=yes ac_cv_header_search_h=no ac_cv_header_sys_shm_h=no \
+		--with-contrib=$BUILD_PATH/wasm32-unknown-emscripten
+
+    checkfail "vlc build: configure failed"
+fi
+
+emmake make ${MAKEFLAGS}
+checkfail "vlc build: make failed"
+
+cd $BUILD_PATH
+
+# Build and compile static modules entry points
+# start by deleting the previous version so that it's not overwritten
+rm -fr $BUILDDIR_NAME/vlc-modules.c $BUILDDIR_NAME/vlc-modules.bc
+
+NM="$EMSDK/upstream/bin/llvm-nm"
+cd $BUILDDIR_NAME/modules/.libs
+
+# create module list
+echo "creating module list"
+touch $BUILD_PATH/$BUILDDIR_NAME/vlc-modules.c
+printf "// This file is autogenerated\n" > $BUILD_PATH/$BUILDDIR_NAME/vlc-modules.c
+printf "#include <unistd.h>\n\n" >> $BUILD_PATH/$BUILDDIR_NAME/vlc-modules.c
+
+BUILTINS="const void *vlc_static_modules[] = {\n"
+LDFLAGS=""
+DEFINITIONS=""
+VLCMODULES=""
+
+for i in `ls *plugin.a`
+do
+    VLCMODULES="$i $VLCMODULES"
+done
+
+for file in $VLCMODULES
+    do
+        symbols=$($NM -g $file)
+        entryname=$(get_symbol "$symbols" _)
+        DEFINITIONS+="int $entryname (int (*)(void *, void *, int, ...), void *);\n";
+        BUILTINS+=" $entryname,\n"
+        LDFLAGS+="\$BUILD_PATH/$BUILDDIR_NAME/modules/.libs/$file "
+    done;
+
+BUILTINS="$BUILTINS NULL\n};\n"
+printf "$DEFINITIONS\n$BUILTINS" >> $BUILD_PATH/$BUILDDIR_NAME/vlc-modules.c
+
+# compile vlc-modules.c
+emcc -pthread -c $BUILD_PATH/$BUILDDIR_NAME/vlc-modules.c -o $BUILD_PATH/$BUILDDIR_NAME/vlc-modules.bc
+checkfail "vlc static modules: compilation failed"
+
+cd $BUILD_PATH
+echo "VLC for wasm32-unknown-emscripten built!"
-- 
2.31.1

