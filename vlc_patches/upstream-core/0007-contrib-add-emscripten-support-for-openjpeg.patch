From ae8fe07aa1108289f9a7a321d5da6e6c56174b28 Mon Sep 17 00:00:00 2001
From: Mehdi Sabwat <mehdi@videolabs.io>
Date: Tue, 19 May 2020 13:24:42 +0000
Subject: [PATCH 07/16] contrib: add emscripten support for openjpeg

---
 contrib/src/openjpeg/emscripten.patch | 26 ++++++++++++++++++++++++++
 contrib/src/openjpeg/rules.mak        |  1 +
 2 files changed, 27 insertions(+)
 create mode 100644 contrib/src/openjpeg/emscripten.patch

diff --git a/contrib/src/openjpeg/emscripten.patch b/contrib/src/openjpeg/emscripten.patch
new file mode 100644
index 0000000000..8150d8d49d
--- /dev/null
+++ b/contrib/src/openjpeg/emscripten.patch
@@ -0,0 +1,26 @@
+From df73904929e9a7c3a48d63beb347fbf3c52b7300 Mon Sep 17 00:00:00 2001
+From: Mehdi Sabwat <mehdisabwat@gmail.com>
+Date: Mon, 26 Apr 2021 15:37:44 +0200
+Subject: [PATCH] emscripten: disable big endian test
+
+This test should not run on the emscripten platform because of :
+https://github.com/emscripten-core/emscripten/blob/dff33368427fba16745c8ce52f11484a67b2855d/cmake/Modules/TestBigEndian.cmake#L5
+---
+ CMakeLists.txt | 2 ++
+ 1 file changed, 2 insertions(+)
+
+diff --git a/CMakeLists.txt b/CMakeLists.txt
+index 136d72878..1e3adacda 100644
+--- a/CMakeLists.txt
++++ b/CMakeLists.txt
+@@ -162,8 +162,10 @@ endif()
+ 
+ #-----------------------------------------------------------------------------
+ # Big endian test:
++if (!EMSCRIPTEN)
+ include (${CMAKE_ROOT}/Modules/TestBigEndian.cmake)
+ TEST_BIG_ENDIAN(OPJ_BIG_ENDIAN)
++endif()
+ 
+ #-----------------------------------------------------------------------------
+ # Setup file for setting custom ctest vars
diff --git a/contrib/src/openjpeg/rules.mak b/contrib/src/openjpeg/rules.mak
index e485651354..42f299ce51 100644
--- a/contrib/src/openjpeg/rules.mak
+++ b/contrib/src/openjpeg/rules.mak
@@ -22,6 +22,7 @@ endif
 	$(APPLY) $(SRC)/openjpeg/install.patch
 	$(APPLY) $(SRC)/openjpeg/pic.patch
 	$(APPLY) $(SRC)/openjpeg/openjp2_pthread.patch
+	$(APPLY) $(SRC)/openjpeg/emscripten.patch
 	$(call pkg_static,"./src/lib/openjp2/libopenjp2.pc.cmake.in")
 	$(MOVE)
 
-- 
2.31.1

