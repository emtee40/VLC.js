From 3b473e8058eb3106872e712b946655c096b3cf2d Mon Sep 17 00:00:00 2001
From: Mehdi Sabwat <mehdi@videolabs.io>
Date: Wed, 20 May 2020 01:31:35 +0000
Subject: [PATCH 03/16] compat: add clock_nanosleep & sigwait support for
 emscripten

---
 compat/clock_nanosleep.c | 9 +++++++--
 configure.ac             | 2 ++
 2 files changed, 9 insertions(+), 2 deletions(-)

diff --git a/compat/clock_nanosleep.c b/compat/clock_nanosleep.c
index 494540b8b9..c125ee95fc 100644
--- a/compat/clock_nanosleep.c
+++ b/compat/clock_nanosleep.c
@@ -20,7 +20,7 @@
  * Inc., 51 Franklin Street, Fifth Floor, Boston MA 02110-1301, USA.
  *****************************************************************************/
 
-#ifdef __APPLE__
+#if defined(__APPLE__) || defined (__EMSCRIPTEN__)
 
 #ifdef HAVE_CONFIG_H
 # include <config.h>
@@ -32,7 +32,12 @@
 #include <sys/types.h>
 #include <sys/time.h>
 #include <sys/sysctl.h>
-#include <mach/clock_types.h>
+#ifdef __EMSCRIPTEN__
+# define NSEC_PER_SEC 1000000000L
+#else
+# include <mach/clock_types.h>
+
+#endif
 
 int clock_nanosleep(clockid_t clock_id, int flags,
         const struct timespec *rqtp, struct timespec *rmtp)
diff --git a/configure.ac b/configure.ac
index 025c5ea879..08e3f849d8 100644
--- a/configure.ac
+++ b/configure.ac
@@ -373,6 +373,8 @@ case "${host_os}" in
     ;;
   *emscripten*)
     SYS=emscripten
+    AC_LIBOBJ([clock_nanosleep])
+    AC_LIBOBJ([sigwait])
     CC=emcc
     LD=emcc
     LDSHARED=emcc
-- 
2.31.1

