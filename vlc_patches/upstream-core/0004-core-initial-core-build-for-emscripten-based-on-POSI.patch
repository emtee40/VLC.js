From e4c79d00bce6b2808f89f2ec6ba2dc7538e702ea Mon Sep 17 00:00:00 2001
From: Mehdi Sabwat <mehdi@videolabs.io>
Date: Tue, 27 Apr 2021 15:33:10 +0200
Subject: [PATCH 04/16] core: initial core build for emscripten, based on POSIX

posix/sort.c won't be added because qsort_r is not supported.

- add vlc_getProxyUrl stub for emscripten

- implement vlc_thread_id() for emscripten

- add weak attribute support for wasm

Co-Authored-By: Jean-Baptiste Kempf <jb@videolan.org>
---
 include/vlc_common.h     |  2 +-
 src/Makefile.am          | 17 ++++++++++++++++-
 src/emscripten/netconf.c | 19 +++++++++++++++++++
 src/emscripten/thread.c  | 10 ++++++++++
 4 files changed, 46 insertions(+), 2 deletions(-)
 create mode 100644 src/emscripten/netconf.c
 create mode 100644 src/emscripten/thread.c

diff --git a/include/vlc_common.h b/include/vlc_common.h
index f62ff86d04..3f64caa455 100644
--- a/include/vlc_common.h
+++ b/include/vlc_common.h
@@ -185,7 +185,7 @@
 # define VLC_USED
 #endif
 
-#if defined (__ELF__) || defined (__MACH__)
+#if defined (__ELF__) || defined (__MACH__) || defined (__wasm__)
 # define VLC_WEAK __attribute__((weak))
 #else
 /**
diff --git a/src/Makefile.am b/src/Makefile.am
index ae580acc68..5a68efae25 100644
--- a/src/Makefile.am
+++ b/src/Makefile.am
@@ -431,6 +431,19 @@ libvlccore_la_SOURCES += \
 	os2/thread.c
 endif
 
+if HAVE_EMSCRIPTEN
+libvlccore_la_SOURCES += \
+	posix/thread.c \
+	posix/getaddrinfo.c \
+	posix/error.c \
+	posix/dirs.c \
+	posix/filesystem.c \
+	posix/specific.c \
+	posix/timer.c \
+	emscripten/netconf.c \
+	emscripten/thread.c
+endif
+
 if HAVE_DARWIN
 libvlccore_la_SOURCES += \
 	darwin/error.c \
@@ -473,8 +486,10 @@ if !HAVE_LINUX
 libvlccore_la_SOURCES += posix/wait.c
 endif
 if !HAVE_ANDROID
+if !HAVE_EMSCRIPTEN
+libvlccore_la_SOURCES += posix/sort.c
+endif
 libvlccore_la_SOURCES += \
-	posix/sort.c \
 	posix/thread.c
 if !HAVE_DARWIN
 libvlccore_la_SOURCES += \
diff --git a/src/emscripten/netconf.c b/src/emscripten/netconf.c
new file mode 100644
index 0000000000..4d29b4cb4c
--- /dev/null
+++ b/src/emscripten/netconf.c
@@ -0,0 +1,19 @@
+#ifdef HAVE_CONFIG_H
+# include "config.h"
+#endif
+#include <strings.h>
+#include <vlc_common.h>
+
+char *vlc_getProxyUrl(const char *url);
+
+/**
+ * Determines the network proxy server to use (if any).
+ * @param url absolute URL for which to get the proxy server
+ * @return proxy URL, NULL if no proxy or error
+ */
+char *vlc_getProxyUrl(const char *url)
+{
+    VLC_UNUSED(url);
+    // TODO: add proxy url to url  
+    return NULL;
+}
diff --git a/src/emscripten/thread.c b/src/emscripten/thread.c
new file mode 100644
index 0000000000..cdc7bc7685
--- /dev/null
+++ b/src/emscripten/thread.c
@@ -0,0 +1,10 @@
+#ifdef HAVE_CONFIG_H
+# include "config.h"
+#endif
+
+#include <pthread.h>
+
+unsigned long vlc_thread_id(void)
+{
+    return pthread_self();
+}
-- 
2.31.1

