From 5b6004917512f7de3548702e02c4753fb5a638f2 Mon Sep 17 00:00:00 2001
From: Jameson Ernst <jameson@jpernst.com>
Date: Fri, 7 Jul 2017 11:49:02 -0700
Subject: [PATCH 07/23] Minor fix to AL panner initialization when source has
 leading zero-buffers

---
 src/library_openal.js | 10 +++++++++-
 1 file changed, 9 insertions(+), 1 deletion(-)

diff --git a/src/library_openal.js b/src/library_openal.js
index c6e326fcc..7f65f6d67 100644
--- a/src/library_openal.js
+++ b/src/library_openal.js
@@ -376,8 +376,16 @@ var LibraryOpenAL = {
         return;
       }
 
+      // Find the first non-zero buffer in the queue to determine the proper format
+      var templateBuf = AL.buffers[0];
+      for (var i = 0; i < src.bufQueue.length; i++) {
+        if (src.bufQueue[i].id !== 0) {
+          templateBuf = src.bufQueue[i];
+          break;
+        }
+      }
       // Create a panner if AL_SOURCE_SPATIALIZE_SOFT is set to true, or alternatively if it's set to auto and the source is mono
-      if (src.spatialize === 1 /* AL_TRUE */ || (src.spatialize === 2 /* AL_AUTO_SOFT */ && src.bufQueue[0].channels === 1)) {
+      if (src.spatialize === 1 /* AL_TRUE */ || (src.spatialize === 2 /* AL_AUTO_SOFT */ && templateBuf.channels === 1)) {
         if (src.panner) {
           return;
         }
-- 
2.14.1

