<!doctype html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>VLC.js</title>
    <style>
        .emscripten {
            text-align: center;
        }
        body {
            background-color: #343a40;
        }
        #canvas {
            border:0 !important;
            display: flex;
            margin: 0 auto;
            background-color: #000;
        }
        #overlay {
            border:0 !important;
            display: flex;
            margin: 0 auto;
        }
        #stack {
            display: grid;
        }
        #stack > canvas {
            grid-column: 1;
            grid-row: 1;
        }
        #spinner {
            display: none;
        }
        #status {
            display: none;
        }
        #progress {
            margin-left: auto;
            margin-right: auto;
        }
        #logo {
            width: 64px;
            height: 64px;
        }
        #em_logo {
            position: absolute;
            width: 200px;
            height: 80px;
        }
        #point {
            color: #fff;
            font-size: 60px;
        }
        #js {
            color: #fff;
            font-size: 60px;
            font-weight: bold;
        }
        .banner {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .vlc_head {
            flex: 1 1 0px;
        }
    </style>
</head>
<body>
    <div class="emscripten_border">
    <div class="emscripten">
        <progress id="progress" value="0" max="100"></progress>
        <div class="spinner" id='spinner'></div>
        <div class="emscripten" id="status">Downloading...</div>
    </div>
    </div>
    <br></br>
    <label for="opts">Enter libvlc options here:</label>
    <input type="text" size=60 id="opts" name="opts" value="--codec=webcodec --aout=emworklet_audio -vvv"></input>
    <button id="vlc_init">Start libvlc</button>
    <br></br>
    <div id="stack">
        <canvas
          class="emscripten" id="canvas"
          oncontextmenu="event.preventDefault()" tabindex=-1
          width=1280 height=720
        ></canvas>
        <canvas
          class="emscripten hidden" id="overlay"
          oncontextmenu="event.preventDefault()" tabindex=-2
          width=1280 height=720
        ></canvas>
    </div>
    <!-- from https://github.com/gzuidhof/coi-serviceworker -->
    <script src="./coi-serviceworker.js"></script>
    <script src="./lib/module-loader.js"></script>
    <script src="./experimental.js"></script>
    <script type="module">
      import { update_overlay, on_overlay_click } from "./lib/overlay.js";
      import { MediaPlayer } from "./lib/libvlc.js";

      var vlc_options = "";

      // VlcModule is a function generated by emscripten in experimental.js,
      // that loads the wasm file and generates a module object from it.
      // VlcModuleExt is an object defined in 'lib/module-loader.js' with a
      // bunch of options; also, all the fields of VlcModuleExt are added to
      // the returned Module.

      globalThis.Module = await initModule(VlcModuleExt);

      window.onerror = function(event) {
        // TODO: do not warn on ok events like simulating an infinite loop or exitStatus
        Module.setStatus('Exception thrown, see JavaScript console');
        spinnerElement.style.display = 'none';
        Module.setStatus = function(text) {
          if (text) Module.printErr('[post-exception status] ' + text);
        };
      };
      
      const overlay = document.getElementById("overlay");
      let inputElement = document.getElementById("fpicker_btn");
      let init_elem = document.getElementById("vlc_init");
      let options_input = document.getElementById("opts");
      function handleFiles() {
	  // iterator in case the user selected multiple files.
	  for (var i=0; i < this.files.length; i++) {
	      var name = this.files.item(i).name;
	      console.log("opened file: ", name);
	      Module['vlc_access_file'].push(this.files.item(i));
	  }
      }

      inputElement.addEventListener("change", handleFiles, false);  
            
      function handleStart() {
	  vlc_options = options_input.value;
	  console.log("vlc.js: starting vlc.js with : " + vlc_options);
	  let vlc_opts_array = vlc_options.split(' ');


	  let vlc_opts_size = 0;
	  for (let i in vlc_opts_array) {
	      vlc_opts_size += vlc_opts_array[i].length + 1;
	  }
	  var buffer = Module._malloc(vlc_opts_size);
	  var wrote_size = 0;
	  for (let i in vlc_opts_array) {
	      Module.writeAsciiToMemory(vlc_opts_array[i], buffer + wrote_size, true);
	      wrote_size += vlc_opts_array[i].length + 1;
	  }
	  var vlc_argv = Module._malloc(vlc_opts_array.length * 4 + 4);
	  var view_vlc_argv = new Uint32Array(
	      Module.wasmMemory.buffer,
	      vlc_argv,
	      vlc_opts_array.length
	  );
	  wrote_size = 0;
	  for (let i in vlc_opts_array) {
	      view_vlc_argv[i] = buffer + wrote_size;
	      wrote_size += vlc_opts_array[i].length + 1;
	  }
	  Module._wasm_libvlc_init(vlc_opts_array.length, vlc_argv);
	  const media_player = new MediaPlayer(Module, "emjsfile:///mediafile");
	  media_player.set_volume(80);
	  
	  Module._set_global_media_player(media_player.media_player_ptr);
	  window.media_player = media_player;
	  window.on_overlay_click = on_overlay_click;
	  window.update_overlay = update_overlay;      
	  update_overlay(overlay);
      }
      init_elem.addEventListener("click", handleStart, false);

    </script>


</body>
</html>
